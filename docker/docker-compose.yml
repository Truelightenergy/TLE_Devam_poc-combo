services:
  postgres:
    environment:
      - PGUSER=postgres
      - POSTGRES_PASSWORD=postgres
    image: "postgres:15"
    ports:
      - "0.0.0.0:5432:5432"
  postgres-setup-1:
    depends_on:
      - postgres
    environment:
      - PGUSER=postgres
      - PGPASSWORD=postgres
      - DATABASE=postgres
    image: "postgres:15"
    entrypoint:
      - /bin/bash
      - -c 
      - | 
        set -e
        sleep 10 # wait for postgres to be ready
        psql -v ON_ERROR_STOP=1 --username $${PGUSER} --dbname postgres --host $${DATABASE} --port 5432 <<-EOSQL
            CREATE USER docker;
            CREATE DATABASE trueprice;
            GRANT ALL PRIVILEGES ON DATABASE trueprice TO docker;
            -- GRANT ALL ON SCHEMA public TO demo;
            ALTER USER docker WITH encrypted password 'docker';
        EOSQL
  postgres-setup-2:
    depends_on:
      - postgres-setup-1
    environment:
      - PGUSER=docker
      - PGPASSWORD=docker
      - DATABASE=postgres
    image: "postgres:15"
    entrypoint:
    - bin/bash
    - -c
    - |
      set -e
      sleep 10
      psql -v ON_ERROR_STOP=1 --username $${PGUSER} --dbname trueprice --host $${DATABASE} --port 5432 <<-EOSQL
        CREATE SCHEMA trueprice;
        
        -- NYISO energy
        CREATE TABLE trueprice.nyiso_energy (
          id serial PRIMARY KEY,
          cob BOOLEAN,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.nyiso_energy_history (
          id serial PRIMARY KEY,
          cob BOOLEAN,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- ERCOT energy
        CREATE TABLE trueprice.ercot_energy (
          id serial PRIMARY KEY,
          cob BOOLEAN,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.ercot_energy_history (
          id serial PRIMARY KEY,
          cob BOOLEAN,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );


        -- ISONE energy

        CREATE TABLE trueprice.isone_energy (
          id serial PRIMARY KEY,
          cob BOOLEAN,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.isone_energy_history (
          id serial PRIMARY KEY,
          cob BOOLEAN,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );

        -- MISO energy
        CREATE TABLE trueprice.miso_energy (
          id serial PRIMARY KEY,
          cob BOOLEAN,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.miso_energy_history (
          id serial PRIMARY KEY,
          cob BOOLEAN,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );

        -- PJM energy
        CREATE TABLE trueprice.pjm_energy (
          id serial PRIMARY KEY,
          cob BOOLEAN,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.pjm_energy_history (
          id serial PRIMARY KEY,
          cob BOOLEAN,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        

        -- ercot nonenergy
        CREATE TABLE trueprice.ercot_nonenergy (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.ercot_nonenergy_history (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );

        -- isone nonenergy
        CREATE TABLE trueprice.isone_nonenergy (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(12,8), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.isone_nonenergy_history (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(12,8), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );

        -- pjm nonenergy
        CREATE TABLE trueprice.pjm_nonenergy (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.pjm_nonenergy_history (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );

        -- nyiso nonenergy
        CREATE TABLE trueprice.nyiso_nonenergy (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.nyiso_nonenergy_history (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );

      -- miso nonenergy
        CREATE TABLE trueprice.miso_nonenergy (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.miso_nonenergy_history (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );


        -- pjm rec
        -- new data
        CREATE TABLE trueprice.pjm_rec (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.pjm_rec_history (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );

        --ercot rec
        -- new data
        CREATE TABLE trueprice.ercot_rec (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.ercot_rec_history (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );


        --isone rec
        --new data
        CREATE TABLE trueprice.isone_rec (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.isone_rec_history (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );


      -- nyiso rec
      CREATE TABLE trueprice.nyiso_rec (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10), 
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );
        
        -- old data
        -- union old and new data for all data (versus is_current column)
        CREATE TABLE trueprice.nyiso_rec_history (
          id serial PRIMARY KEY,
          curveStart TIMESTAMPTZ, -- per file name (sans tz)
          curveEnd TIMESTAMPTZ, -- per file name (sans tz)
          month TIMESTAMPTZ,
          data NUMERIC(20,10),
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );

        
      --Authentication table
      CREATE TABLE trueprice.users (
        id SERIAL PRIMARY KEY,
        email VARCHAR(255) UNIQUE NOT NULL,
        password VARCHAR(255) NOT NULL,
        privileged_level VARCHAR(255) NOT NULL,
        status text default 'enabled'
      );
      
      -- add new column to user table
      -- Alter table trueprice.users ADD COLUMN status text default 'enabled' ;

      -- status table for uploads
      CREATE TABLE trueprice.uploads(
        id serial PRIMARY KEY,
        timestamp TIMESTAMPTZ,
        email varchar(255),
        filename varchar(255)
      );

      -- site control
      CREATE TABLE trueprice.site(
        id serial PRIMARY KEY,
        admin varchar(100),
        ui_status varchar(100),
        api_status varchar(100)
      );
      
      -- insert to the sit table
      Insert into trueprice.site(admin, ui_status, api_status) VALUES ('tle_admin', 'enabled', 'enabled');

      -- column filtering
        CREATE TABLE trueprice.column_authorization(
          id serial PRIMARY KEY,
          control_table VARCHAR(255) NOT NULL,
          email VARCHAR(255) NOT NULL,
          startMonth TIMESTAMPTZ, -- per file name (sans tz)
          endMonth TIMESTAMPTZ, -- per file name (sans tz)
          control_area varchar(100),
          state varchar(100),
          load_zone varchar(100),
          capacity_zone varchar(100),
          utility varchar(100),
          strip varchar(4),
          cost_group varchar(100),
          cost_component varchar(100),
          sub_cost_component varchar(100)
        );


      EOSQL
  # adminer: # for postgres, php admin interface
  #   image: adminer
  #   restart: always
  #   ports:
  #     - "0.0.0.0:8080:8080"
  # grafana:
  #   image: "grafana/grafana-oss"
  #   ports:
  #     - "0.0.0.0:3000:3000"
  # ingestor:
  #   environment:
  #     - PGUSER=docker
  #     - PGPASSWORD=docker
  #     - DATABASE=$${DATABASE}
  #   depends_on:
  #     - postgres-setup-2
  #   build:
  #     context: ../buildContext # relative to vscode project
  #     dockerfile: ./src/Dockerfile-ingestor # relative to context directory
  # trueprice-api:
  #   environment:
  #     - PGUSER=docker
  #     - PGPASSWORD=docker
  #     - DATABASE=$${DATABASE}
  #   depends_on:
  #     - postgres-setup-2
  #   build:
  #     context: ../buildContext
  #     dockerfile: ./src/Dockerfile-trueprice-api
  #   ports:
  #     - "0.0.0.0:5050:5000"


# --- postgres
# docker container run --name some-postgres -e POSTGRES_PASSWORD=postgres -p 0.0.0.0:5432:5432 -d postgres
# create database trueprice;
# \c trueprice;
# create table data (id serial PRIMARY KEY, amount NUMERIC(12,8), hour TIMESTAMP);
# insert into data (amount, hour) values (1.0, TO_TIMESTAMP('6/1/2022', 'MM/DD/YYYY'));
# select * from data;
# --- grafana
# for grafana, use $${DATABASE}:5432
# docker container run -p 3000:3000 grafana/grafana-oss     